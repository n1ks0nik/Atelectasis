/**
 * –ü—Ä–æ—Å—Ç–æ–π DICOM Viewer
 * –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è DICOM –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
 */

let currentCanvas = null;
let currentImageData = null;
let contrast = 1.0;
let brightness = 0;

/**
 * –û—Ç–∫—Ä—ã—Ç–∏–µ DICOM —Ñ–∞–π–ª–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
 */
async function viewDicomFile(studyId, fileType) {
    try {
        const response = await authorizedFetch(`/download/dicom/${studyId}/${fileType}`);

        if (!response.ok) {
            throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        const arrayBuffer = await response.arrayBuffer();
        const uint8Array = new Uint8Array(arrayBuffer);

        // –ü—Ä–æ—Å—Ç–∞—è —ç–º—É–ª—è—Ü–∏—è DICOM –ø–∞—Ä—Å–∏–Ω–≥–∞
        // –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Ç–∏–ø–∞ cornerstone.js –∏–ª–∏ dicom-parser
        await displayMockDicomImage(studyId, fileType);

        showDicomModal();

    } catch (error) {
        console.error('Error viewing DICOM:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è DICOM —Ñ–∞–π–ª–∞', 'error');
    }
}

/**
 * –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ–∫ DICOM –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
 * –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã –Ω–∞—Å—Ç–æ—è—â–∏–π DICOM –ø–∞—Ä—Å–µ—Ä
 */
async function displayMockDicomImage(studyId, fileType) {
    const canvas = document.getElementById('dicom-canvas');
    const ctx = canvas.getContext('2d');

    currentCanvas = canvas;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
    canvas.width = 512;
    canvas.height = 512;

    // –°–æ–∑–¥–∞–µ–º –º–æ–∫ —Ä–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const imageData = ctx.createImageData(512, 512);
    const data = imageData.data;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç, –∏–º–∏—Ç–∏—Ä—É—é—â–∏–π —Ä–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    for (let y = 0; y < 512; y++) {
        for (let x = 0; x < 512; x++) {
            const index = (y * 512 + x) * 4;

            // –°–æ–∑–¥–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω, –Ω–∞–ø–æ–º–∏–Ω–∞—é—â–∏–π –ª–µ–≥–∫–∏–µ
            let intensity = 50; // –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ª–µ–≥–∫–∏—Ö
            const centerX = 256;
            const centerY = 256;
            const distanceFromCenter = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);

            // –°–æ–∑–¥–∞–µ–º –æ–≤–∞–ª—å–Ω—É—é —Ñ–æ—Ä–º—É –¥–ª—è –ª–µ–≥–∫–∏—Ö
            if (distanceFromCenter < 200) {
                intensity += 30 + Math.sin(x / 20) * 10 + Math.sin(y / 25) * 8;

                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞
                if (x % 40 < 2) {
                    intensity += 40;
                }

                // –ï—Å–ª–∏ —ç—Ç–æ –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ
                if (fileType === 'annotated') {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∞—Ç–µ–ª–µ–∫—Ç–∞–∑–∞
                    if (x > 150 && x < 250 && y > 180 && y < 280) {
                        data[index] = Math.min(255, intensity + 100);     // R
                        data[index + 1] = intensity;                      // G
                        data[index + 2] = intensity;                      // B
                        data[index + 3] = 255;                           // A
                        continue;
                    }
                }
            }

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
            intensity = Math.max(0, Math.min(255, intensity));

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ RGB –∫–∞–Ω–∞–ª–∞–º (—Å–µ—Ä—ã–π)
            data[index] = intensity;     // R
            data[index + 1] = intensity; // G
            data[index + 2] = intensity; // B
            data[index + 3] = 255;       // A
        }
    }

    currentImageData = imageData;

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    ctx.putImageData(imageData, 0, 0);

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    if (fileType === 'annotated') {
        drawAnnotations(ctx, studyId);
    }
}

/**
 * –†–∏—Å–æ–≤–∞–Ω–∏–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
 */
function drawAnnotations(ctx, studyId) {
    // –†–∏—Å—É–µ–º —Ä–∞–º–∫—É –≤–æ–∫—Ä—É–≥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
    ctx.strokeStyle = '#ff0000';
    ctx.lineWidth = 3;
    ctx.strokeRect(150, 180, 100, 100);

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
    ctx.fillStyle = '#ff0000';
    ctx.font = 'bold 16px Arial';
    ctx.fillText('Atelectasis: 85.2%', 160, 170);

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ
    ctx.fillStyle = '#ffff00';
    ctx.font = '12px Arial';
    ctx.fillText(`AI Analysis - Study: ${studyId.substring(0, 8)}`, 10, 25);
    ctx.fillText('Generated by Atelectasis Detection System', 10, 40);
    ctx.fillText('For demonstration purposes only', 10, 500);
}

/**
 * –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ DICOM viewer
 */
function showDicomModal() {
    const modal = document.getElementById('dicom-modal');
    modal.classList.add('show');

    // –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫
    contrast = 1.0;
    brightness = 0;
}

/**
 * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
 */
function adjustContrast(delta) {
    if (!currentCanvas || !currentImageData) return;

    contrast += delta / 100;
    contrast = Math.max(0.1, Math.min(3.0, contrast));

    applyImageAdjustments();
}

/**
 * –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
 */
function applyImageAdjustments() {
    if (!currentCanvas || !currentImageData) return;

    const ctx = currentCanvas.getContext('2d');
    const imageData = ctx.createImageData(currentImageData.width, currentImageData.height);
    const originalData = currentImageData.data;
    const newData = imageData.data;

    for (let i = 0; i < originalData.length; i += 4) {
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ç—Ä–∞—Å—Ç –∏ —è—Ä–∫–æ—Å—Ç—å
        let r = originalData[i];
        let g = originalData[i + 1];
        let b = originalData[i + 2];

        // –ö–æ–Ω—Ç—Ä–∞—Å—Ç
        r = ((r - 128) * contrast) + 128;
        g = ((g - 128) * contrast) + 128;
        b = ((b - 128) * contrast) + 128;

        // –Ø—Ä–∫–æ—Å—Ç—å
        r += brightness;
        g += brightness;
        b += brightness;

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
        newData[i] = Math.max(0, Math.min(255, r));
        newData[i + 1] = Math.max(0, Math.min(255, g));
        newData[i + 2] = Math.max(0, Math.min(255, b));
        newData[i + 3] = originalData[i + 3]; // Alpha
    }

    ctx.putImageData(imageData, 0, 0);
}

/**
 * –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
 */
function resetView() {
    contrast = 1.0;
    brightness = 0;

    if (currentCanvas && currentImageData) {
        const ctx = currentCanvas.getContext('2d');
        ctx.putImageData(currentImageData, 0, 0);
    }
}

/**
 * –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π DICOM
 */
function enhanceResultModal() {
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const additionalStyles = `
        .study-details {
            max-height: none;
        }
        
        .detail-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-section h4 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .detail-item label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .detail-item span {
            font-size: 1rem;
        }
        
        .analysis-results {
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .probability-display {
            text-align: center;
        }
        
        .probability-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            background: conic-gradient(from 0deg, var(--success-color) 0%, var(--success-color) var(--percentage, 0%), #e9ecef var(--percentage, 0%), #e9ecef 100%);
        }
        
        .probability-circle::before {
            content: '';
            position: absolute;
            inset: 10px;
            border-radius: 50%;
            background: white;
        }
        
        .probability-value, .probability-label {
            position: relative;
            z-index: 1;
        }
        
        .probability-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .probability-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .high-risk .probability-circle {
            background: conic-gradient(from 0deg, var(--error-color) 0%, var(--error-color) var(--percentage, 0%), #e9ecef var(--percentage, 0%), #e9ecef 100%);
        }
        
        .medium-risk .probability-circle {
            background: conic-gradient(from 0deg, var(--warning-color) 0%, var(--warning-color) var(--percentage, 0%), #e9ecef var(--percentage, 0%), #e9ecef 100%);
        }
        
        .result-details {
            flex: 1;
            display: grid;
            gap: 1rem;
        }
        
        .conclusion-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--info-color);
        }
        
        .conclusion-section h5 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .conclusion-text {
            line-height: 1.6;
            color: var(--text-color);
        }
        
        .error-info, .processing-info {
            text-align: center;
            padding: 2rem;
        }
        
        .processing-spinner {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .filename {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .probability {
            font-weight: bold;
        }
        
        .probability.high-risk {
            color: var(--error-color);
        }
        
        .probability.medium-risk {
            color: var(--warning-color);
        }
        
        .probability.low-risk {
            color: var(--success-color);
        }
        
        .study-id {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .result-summary {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .dicom-viewer-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç
    if (!document.getElementById('results-styles')) {
        const styleElement = document.createElement('style');
        styleElement.id = 'results-styles';
        styleElement.textContent = additionalStyles;
        document.head.appendChild(styleElement);
    }
}

/**
 * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ DICOM –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
 */
function addDicomViewButtons(studyId, reports) {
    if (!reports) return '';

    let buttons = '';

    if (reports.dicom_sr) {
        buttons += `
            <button class="btn btn-outline btn-small" onclick="viewDicomFile('${studyId}', 'sr')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞">
                <i class="fas fa-file-medical"></i>
                DICOM SR
            </button>
        `;
    }

    if (reports.dicom_annotated) {
        buttons += `
            <button class="btn btn-outline btn-small" onclick="viewDicomFile('${studyId}', 'annotated')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                <i class="fas fa-image"></i>
                –ê–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ
            </button>
        `;
    }

    return buttons ? `<div class="dicom-viewer-actions">${buttons}</div>` : '';
}

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DICOM viewer
 */
document.addEventListener('DOMContentLoaded', function() {
    enhanceResultModal();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
    document.getElementById('dicom-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeDicomModal();
        }
    });

    document.getElementById('result-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
});

/**
 * –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ DICOM —Ñ–∞–π–ª–∞
 * –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã –Ω–∞—Å—Ç–æ—è—â–∏–π DICOM –ø–∞—Ä—Å–µ—Ä
 */
async function mockDicomLoader(arrayBuffer) {
    // –ü—Ä–æ—Å—Ç–∞—è –∏–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ DICOM
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve({
                width: 512,
                height: 512,
                pixelData: new Uint16Array(512 * 512),
                windowCenter: 400,
                windowWidth: 1600,
                patientName: 'DEMO^PATIENT',
                studyDate: '20241201',
                modality: 'DX'
            });
        }, 500);
    });
}

/**
 * –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π DICOM viewer
 */
function showDicomFeatures() {
    const features = [
        'üîç –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ',
        'üéõÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –∏ —è—Ä–∫–æ—Å—Ç–∏',
        'üìê –ò–∑–º–µ—Ä–µ–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π',
        'üéØ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç–æ–ª–æ–≥–∏–π',
        'üìä –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ DICOM –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö',
        'üíæ –≠–∫—Å–ø–æ—Ä—Ç –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π',
        'üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PACS —Å–∏—Å—Ç–µ–º–∞–º–∏',
        '‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤'
    ];

    showInfoModal('–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ DICOM Viewer', `
        <p>–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π DICOM viewer –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:</p>
        <ul style="list-style: none; padding-left: 0;">
            ${features.map(feature => `<li style="margin-bottom: 0.5rem;">${feature}</li>`).join('')}
        </ul>
        <p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. 
        –í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –±—É–¥–µ—Ç –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ DICOM —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞.</p>
    `);
}

/**
 * –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
 */
window.DicomViewer = {
    viewFile: viewDicomFile,
    adjustContrast: adjustContrast,
    resetView: resetView,
    showFeatures: showDicomFeatures
};